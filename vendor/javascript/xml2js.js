import r from"xmlbuilder";import t from"sax";import e from"events";import s from"./processors.js";import i from"timers";var n={};(function(){n.defaults={.1:{explicitCharkey:false,trim:true,normalize:true,normalizeTags:false,attrkey:"@",charkey:"#",explicitArray:false,ignoreAttrs:false,mergeAttrs:false,explicitRoot:false,validator:null,xmlns:false,explicitChildren:false,childkey:"@@",charsAsChildren:false,includeWhiteChars:false,async:false,strict:true,attrNameProcessors:null,attrValueProcessors:null,tagNameProcessors:null,valueProcessors:null,emptyTag:""},.2:{explicitCharkey:false,trim:false,normalize:false,normalizeTags:false,attrkey:"$",charkey:"_",explicitArray:true,ignoreAttrs:false,mergeAttrs:false,explicitRoot:true,validator:null,xmlns:false,explicitChildren:false,preserveChildrenOrder:false,childkey:"$$",charsAsChildren:false,includeWhiteChars:false,async:false,strict:true,attrNameProcessors:null,attrValueProcessors:null,tagNameProcessors:null,valueProcessors:null,rootName:"root",xmldec:{version:"1.0",encoding:"UTF-8",standalone:true},doctype:null,renderOpts:{pretty:true,indent:"  ",newline:"\n"},headless:false,chunkSize:1e4,emptyTag:"",cdata:false}}}).call(n);var o="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var a={};(function(){var t,e,s,i,l,p={}.hasOwnProperty;t=r;e=n.defaults;i=function(r){return"string"===typeof r&&(r.indexOf("&")>=0||r.indexOf(">")>=0||r.indexOf("<")>=0)};l=function(r){return"<![CDATA["+s(r)+"]]>"};s=function(r){return r.replace("]]>","]]]]><![CDATA[>")};a.Builder=function(){function Builder(r){var t,s,i;(this||o).options={};s=e["0.2"];for(t in s)if(p.call(s,t)){i=s[t];(this||o).options[t]=i}for(t in r)if(p.call(r,t)){i=r[t];(this||o).options[t]=i}}Builder.prototype.buildObject=function(r){var s,n,a,c,u;s=(this||o).options.attrkey;n=(this||o).options.charkey;if(1===Object.keys(r).length&&(this||o).options.rootName===e["0.2"].rootName){u=Object.keys(r)[0];r=r[u]}else u=(this||o).options.rootName;a=function(r){return function(t,e){var o,c,u,h,f,d;if("object"!==typeof e)r.options.cdata&&i(e)?t.raw(l(e)):t.txt(e);else if(Array.isArray(e)){for(h in e)if(p.call(e,h)){c=e[h];for(f in c){u=c[f];t=a(t.ele(f),u).up()}}}else for(f in e)if(p.call(e,f)){c=e[f];if(f===s){if("object"===typeof c)for(o in c){d=c[o];t=t.att(o,d)}}else if(f===n)t=r.options.cdata&&i(c)?t.raw(l(c)):t.txt(c);else if(Array.isArray(c)){for(h in c)if(p.call(c,h)){u=c[h];t="string"===typeof u?r.options.cdata&&i(u)?t.ele(f).raw(l(u)).up():t.ele(f,u).up():a(t.ele(f),u).up()}}else if("object"===typeof c)t=a(t.ele(f),c).up();else if("string"===typeof c&&r.options.cdata&&i(c))t=t.ele(f).raw(l(c)).up();else{null==c&&(c="");t=t.ele(f,c.toString()).up()}}return t}}(this||o);c=t.create(u,(this||o).options.xmldec,(this||o).options.doctype,{headless:(this||o).options.headless,allowSurrogateChars:(this||o).options.allowSurrogateChars});return a(c,r).end((this||o).options.renderOpts)};return Builder}()}).call(a);var l={};(function(){l.stripBOM=function(r){return"\ufeff"===r[0]?r.substring(1):r}}).call(l);var p="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var c={};(function(){var r,o,a,u,h,f,d,m,bind=function(r,t){return function(){return r.apply(t,arguments)}},extend=function(r,t){for(var e in t)y.call(t,e)&&(r[e]=t[e]);function ctor(){(this||p).constructor=r}ctor.prototype=t.prototype;r.prototype=new ctor;r.__super__=t.prototype;return r},y={}.hasOwnProperty;d=t;a=e;r=l;f=s;m=i.setImmediate;o=n.defaults;u=function(r){return"object"===typeof r&&null!=r&&0===Object.keys(r).length};h=function(r,t,e){var s,i,n;for(s=0,i=r.length;s<i;s++){n=r[s];t=n(t,e)}return t};c.Parser=function(t){extend(Parser,t);function Parser(r){(this||p).parseStringPromise=bind((this||p).parseStringPromise,this||p);(this||p).parseString=bind((this||p).parseString,this||p);(this||p).reset=bind((this||p).reset,this||p);(this||p).assignOrPush=bind((this||p).assignOrPush,this||p);(this||p).processAsync=bind((this||p).processAsync,this||p);var t,e,s;if(!((this||p)instanceof c.Parser))return new c.Parser(r);(this||p).options={};e=o["0.2"];for(t in e)if(y.call(e,t)){s=e[t];(this||p).options[t]=s}for(t in r)if(y.call(r,t)){s=r[t];(this||p).options[t]=s}(this||p).options.xmlns&&((this||p).options.xmlnskey=(this||p).options.attrkey+"ns");if((this||p).options.normalizeTags){(this||p).options.tagNameProcessors||((this||p).options.tagNameProcessors=[]);(this||p).options.tagNameProcessors.unshift(f.normalize)}this.reset()}Parser.prototype.processAsync=function(){var r,t;try{if((this||p).remaining.length<=(this||p).options.chunkSize){r=(this||p).remaining;(this||p).remaining="";(this||p).saxParser=(this||p).saxParser.write(r);return(this||p).saxParser.close()}r=(this||p).remaining.substr(0,(this||p).options.chunkSize);(this||p).remaining=(this||p).remaining.substr((this||p).options.chunkSize,(this||p).remaining.length);(this||p).saxParser=(this||p).saxParser.write(r);return m((this||p).processAsync)}catch(r){t=r;if(!(this||p).saxParser.errThrown){(this||p).saxParser.errThrown=true;return this.emit(t)}}};Parser.prototype.assignOrPush=function(r,t,e){if(t in r){r[t]instanceof Array||(r[t]=[r[t]]);return r[t].push(e)}return(this||p).options.explicitArray?r[t]=[e]:r[t]=e};Parser.prototype.reset=function(){var r,t,e,s;this.removeAllListeners();(this||p).saxParser=d.parser((this||p).options.strict,{trim:false,normalize:false,xmlns:(this||p).options.xmlns});(this||p).saxParser.errThrown=false;(this||p).saxParser.onerror=function(r){return function(t){r.saxParser.resume();if(!r.saxParser.errThrown){r.saxParser.errThrown=true;return r.emit("error",t)}}}(this||p);(this||p).saxParser.onend=function(r){return function(){if(!r.saxParser.ended){r.saxParser.ended=true;return r.emit("end",r.resultObject)}}}(this||p);(this||p).saxParser.ended=false;(this||p).EXPLICIT_CHARKEY=(this||p).options.explicitCharkey;(this||p).resultObject=null;s=[];r=(this||p).options.attrkey;t=(this||p).options.charkey;(this||p).saxParser.onopentag=function(e){return function(i){var n,o,a,l,p;a={};a[t]="";if(!e.options.ignoreAttrs){p=i.attributes;for(n in p)if(y.call(p,n)){r in a||e.options.mergeAttrs||(a[r]={});o=e.options.attrValueProcessors?h(e.options.attrValueProcessors,i.attributes[n],n):i.attributes[n];l=e.options.attrNameProcessors?h(e.options.attrNameProcessors,n):n;e.options.mergeAttrs?e.assignOrPush(a,l,o):a[r][l]=o}}a["#name"]=e.options.tagNameProcessors?h(e.options.tagNameProcessors,i.name):i.name;e.options.xmlns&&(a[e.options.xmlnskey]={uri:i.uri,local:i.local});return s.push(a)}}(this||p);(this||p).saxParser.onclosetag=function(r){return function(){var e,i,n,o,a,l,p,c,f,d;l=s.pop();a=l["#name"];r.options.explicitChildren&&r.options.preserveChildrenOrder||delete l["#name"];if(true===l.cdata){e=l.cdata;delete l.cdata}f=s[s.length-1];if(l[t].match(/^\s*$/)&&!e){i=l[t];delete l[t]}else{r.options.trim&&(l[t]=l[t].trim());r.options.normalize&&(l[t]=l[t].replace(/\s{2,}/g," ").trim());l[t]=r.options.valueProcessors?h(r.options.valueProcessors,l[t],a):l[t];1===Object.keys(l).length&&t in l&&!r.EXPLICIT_CHARKEY&&(l=l[t])}u(l)&&(l=""!==r.options.emptyTag?r.options.emptyTag:i);if(null!=r.options.validator){d="/"+function(){var r,t,e;e=[];for(r=0,t=s.length;r<t;r++){o=s[r];e.push(o["#name"])}return e}().concat(a).join("/");(function(){var t;try{return l=r.options.validator(d,f&&f[a],l)}catch(e){t=e;return r.emit("error",t)}})()}if(r.options.explicitChildren&&!r.options.mergeAttrs&&"object"===typeof l)if(r.options.preserveChildrenOrder){if(f){f[r.options.childkey]=f[r.options.childkey]||[];p={};for(n in l)y.call(l,n)&&(p[n]=l[n]);f[r.options.childkey].push(p);delete l["#name"];1===Object.keys(l).length&&t in l&&!r.EXPLICIT_CHARKEY&&(l=l[t])}}else{o={};if(r.options.attrkey in l){o[r.options.attrkey]=l[r.options.attrkey];delete l[r.options.attrkey]}if(!r.options.charsAsChildren&&r.options.charkey in l){o[r.options.charkey]=l[r.options.charkey];delete l[r.options.charkey]}Object.getOwnPropertyNames(l).length>0&&(o[r.options.childkey]=l);l=o}if(s.length>0)return r.assignOrPush(f,a,l);if(r.options.explicitRoot){c=l;l={};l[a]=c}r.resultObject=l;r.saxParser.ended=true;return r.emit("end",r.resultObject)}}(this||p);e=function(r){return function(e){var i,n;n=s[s.length-1];if(n){n[t]+=e;if(r.options.explicitChildren&&r.options.preserveChildrenOrder&&r.options.charsAsChildren&&(r.options.includeWhiteChars||""!==e.replace(/\\n/g,"").trim())){n[r.options.childkey]=n[r.options.childkey]||[];i={"#name":"__text__"};i[t]=e;r.options.normalize&&(i[t]=i[t].replace(/\s{2,}/g," ").trim());n[r.options.childkey].push(i)}return n}}}(this||p);(this||p).saxParser.ontext=e;return(this||p).saxParser.oncdata=function(r){return function(r){var t;t=e(r);if(t)return t.cdata=true}}(this||p)};Parser.prototype.parseString=function(t,e){var s;if(null!=e&&"function"===typeof e){this.on("end",(function(r){this.reset();return e(null,r)}));this.on("error",(function(r){this.reset();return e(r)}))}try{t=t.toString();if(""===t.trim()){this.emit("end",null);return true}t=r.stripBOM(t);if((this||p).options.async){(this||p).remaining=t;m((this||p).processAsync);return(this||p).saxParser}return(this||p).saxParser.write(t).close()}catch(r){s=r;if(!(this||p).saxParser.errThrown&&!(this||p).saxParser.ended){this.emit("error",s);return(this||p).saxParser.errThrown=true}if((this||p).saxParser.ended)throw s}};Parser.prototype.parseStringPromise=function(r){return new Promise(function(t){return function(e,s){return t.parseString(r,(function(r,t){return r?s(r):e(t)}))}}(this||p))};return Parser}(a);c.parseString=function(r,t,e){var s,i,n;if(null!=e){"function"===typeof e&&(s=e);"object"===typeof t&&(i=t)}else{"function"===typeof t&&(s=t);i={}}n=new c.Parser(i);return n.parseString(r,s)};c.parseStringPromise=function(r,t){var e,s;"object"===typeof t&&(e=t);s=new c.Parser(e);return s.parseStringPromise(r)}}).call(c);var u="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var h={};(function(){var r,t,e,i,extend=function(r,t){for(var e in t)o.call(t,e)&&(r[e]=t[e]);function ctor(){(this||u).constructor=r}ctor.prototype=t.prototype;r.prototype=new ctor;r.__super__=t.prototype;return r},o={}.hasOwnProperty;t=n;r=a;e=c;i=s;h.defaults=t.defaults;h.processors=i;h.ValidationError=function(r){extend(ValidationError,r);function ValidationError(r){(this||u).message=r}return ValidationError}(Error);h.Builder=r.Builder;h.Parser=e.Parser;h.parseString=e.parseString;h.parseStringPromise=e.parseStringPromise}).call(h);const f=h.defaults,d=h.processors,m=h.ValidationError,y=h.Builder,g=h.Parser,P=h.parseString,x=h.parseStringPromise;export default h;export{y as Builder,g as Parser,m as ValidationError,f as defaults,P as parseString,x as parseStringPromise,d as processors};

