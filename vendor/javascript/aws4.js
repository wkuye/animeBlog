import*as e from"url";import*as t from"querystring";import*as s from"crypto";import i from"process";import r from"buffer";var n=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var o={};o=function(e){return new LruCache(e)};function LruCache(e){(this||n).capacity=e|0;(this||n).map=Object.create(null);(this||n).list=new DoublyLinkedList}LruCache.prototype.get=function(e){var t=(this||n).map[e];if(t!=null){this.used(t);return t.val}};LruCache.prototype.set=function(e,t){var s=(this||n).map[e];if(s!=null)s.val=t;else{(this||n).capacity||this.prune();if(!(this||n).capacity)return false;s=new DoublyLinkedNode(e,t);(this||n).map[e]=s;(this||n).capacity--}this.used(s);return true};LruCache.prototype.used=function(e){(this||n).list.moveToFront(e)};LruCache.prototype.prune=function(){var e=(this||n).list.pop();if(e!=null){delete(this||n).map[e.key];(this||n).capacity++}};function DoublyLinkedList(){(this||n).firstNode=null;(this||n).lastNode=null}DoublyLinkedList.prototype.moveToFront=function(e){if((this||n).firstNode!=e){this.remove(e);if((this||n).firstNode==null){(this||n).firstNode=e;(this||n).lastNode=e;e.prev=null;e.next=null}else{e.prev=null;e.next=(this||n).firstNode;e.next.prev=e;(this||n).firstNode=e}}};DoublyLinkedList.prototype.pop=function(){var e=(this||n).lastNode;e!=null&&this.remove(e);return e};DoublyLinkedList.prototype.remove=function(e){(this||n).firstNode==e?(this||n).firstNode=e.next:e.prev!=null&&(e.prev.next=e.next);(this||n).lastNode==e?(this||n).lastNode=e.prev:e.next!=null&&(e.next.prev=e.prev)};function DoublyLinkedNode(e,t){(this||n).key=e;(this||n).val=t;(this||n).prev=null;(this||n).next=null}var a=o;var h=e;try{"default"in e&&(h=e.default)}catch(e){}var u=t;try{"default"in t&&(u=t.default)}catch(e){}var c=s;try{"default"in s&&(c=s.default)}catch(e){}var d=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var l={};var p=r.Buffer;var f=i;var g=l,m=h,y=u,v=c,S=a,A=S(1e3);function hmac(e,t,s){return v.createHmac("sha256",e).update(t,"utf8").digest(s)}function hash(e,t){return v.createHash("sha256").update(e,"utf8").digest(t)}function encodeRfc3986(e){return e.replace(/[!'()*]/g,(function(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}))}function encodeRfc3986Full(e){return encodeRfc3986(encodeURIComponent(e))}var q={authorization:true,connection:true,"x-amzn-trace-id":true,"user-agent":true,expect:true,"presigned-expires":true,range:true};function RequestSigner(e,t){typeof e==="string"&&(e=m.parse(e));var s=e.headers=Object.assign({},e.headers||{}),i=(!(this||d).service||!(this||d).region)&&this.matchHost(e.hostname||e.host||s.Host||s.host);(this||d).request=e;(this||d).credentials=t||this.defaultCredentials();(this||d).service=e.service||i[0]||"";(this||d).region=e.region||i[1]||"us-east-1";(this||d).service==="email"&&((this||d).service="ses");!e.method&&e.body&&(e.method="POST");if(!s.Host&&!s.host){s.Host=e.hostname||e.host||this.createHost();e.port&&(s.Host+=":"+e.port)}e.hostname||e.host||(e.hostname=s.Host||s.host);(this||d).isCodeCommitGit=(this||d).service==="codecommit"&&e.method==="GIT";(this||d).extraHeadersToIgnore=e.extraHeadersToIgnore||Object.create(null);(this||d).extraHeadersToInclude=e.extraHeadersToInclude||Object.create(null)}RequestSigner.prototype.matchHost=function(e){var t=(e||"").match(/([^\.]{1,63})\.(?:([^\.]{0,63})\.)?amazonaws\.com(\.cn)?$/);var s=(t||[]).slice(1,3);s[1]!=="es"&&s[1]!=="aoss"||(s=s.reverse());if(s[1]=="s3"){s[0]="s3";s[1]="us-east-1"}else for(var i=0;i<2;i++)if(/^s3-/.test(s[i])){s[1]=s[i].slice(3);s[0]="s3";break}return s};RequestSigner.prototype.isSingleRegion=function(){return["s3","sdb"].indexOf((this||d).service)>=0&&(this||d).region==="us-east-1"||["cloudfront","ls","route53","iam","importexport","sts"].indexOf((this||d).service)>=0};RequestSigner.prototype.createHost=function(){var e=this.isSingleRegion()?"":"."+(this||d).region,t=(this||d).service==="ses"?"email":(this||d).service;return t+e+".amazonaws.com"};RequestSigner.prototype.prepareRequest=function(){this.parsePath();var e,t=(this||d).request,s=t.headers;if(t.signQuery){(this||d).parsedPath.query=e=(this||d).parsedPath.query||{};(this||d).credentials.sessionToken&&(e["X-Amz-Security-Token"]=(this||d).credentials.sessionToken);(this||d).service!=="s3"||e["X-Amz-Expires"]||(e["X-Amz-Expires"]=86400);e["X-Amz-Date"]?(this||d).datetime=e["X-Amz-Date"]:e["X-Amz-Date"]=this.getDateTime();e["X-Amz-Algorithm"]="AWS4-HMAC-SHA256";e["X-Amz-Credential"]=(this||d).credentials.accessKeyId+"/"+this.credentialString();e["X-Amz-SignedHeaders"]=this.signedHeaders()}else{if(!t.doNotModifyHeaders&&!(this||d).isCodeCommitGit){!t.body||s["Content-Type"]||s["content-type"]||(s["Content-Type"]="application/x-www-form-urlencoded; charset=utf-8");!t.body||s["Content-Length"]||s["content-length"]||(s["Content-Length"]=p.byteLength(t.body));!(this||d).credentials.sessionToken||s["X-Amz-Security-Token"]||s["x-amz-security-token"]||(s["X-Amz-Security-Token"]=(this||d).credentials.sessionToken);(this||d).service!=="s3"||s["X-Amz-Content-Sha256"]||s["x-amz-content-sha256"]||(s["X-Amz-Content-Sha256"]=hash((this||d).request.body||"","hex"));s["X-Amz-Date"]||s["x-amz-date"]?(this||d).datetime=s["X-Amz-Date"]||s["x-amz-date"]:s["X-Amz-Date"]=this.getDateTime()}delete s.Authorization;delete s.authorization}};RequestSigner.prototype.sign=function(){(this||d).parsedPath||this.prepareRequest();(this||d).request.signQuery?(this||d).parsedPath.query["X-Amz-Signature"]=this.signature():(this||d).request.headers.Authorization=this.authHeader();(this||d).request.path=this.formatPath();return(this||d).request};RequestSigner.prototype.getDateTime=function(){if(!(this||d).datetime){var e=(this||d).request.headers,t=new Date(e.Date||e.date||new Date);(this||d).datetime=t.toISOString().replace(/[:\-]|\.\d{3}/g,"");(this||d).isCodeCommitGit&&((this||d).datetime=(this||d).datetime.slice(0,-1))}return(this||d).datetime};RequestSigner.prototype.getDate=function(){return this.getDateTime().substr(0,8)};RequestSigner.prototype.authHeader=function(){return["AWS4-HMAC-SHA256 Credential="+(this||d).credentials.accessKeyId+"/"+this.credentialString(),"SignedHeaders="+this.signedHeaders(),"Signature="+this.signature()].join(", ")};RequestSigner.prototype.signature=function(){var e,t,s,i=this.getDate(),r=[(this||d).credentials.secretAccessKey,i,(this||d).region,(this||d).service].join(),n=A.get(r);if(!n){e=hmac("AWS4"+(this||d).credentials.secretAccessKey,i);t=hmac(e,(this||d).region);s=hmac(t,(this||d).service);n=hmac(s,"aws4_request");A.set(r,n)}return hmac(n,this.stringToSign(),"hex")};RequestSigner.prototype.stringToSign=function(){return["AWS4-HMAC-SHA256",this.getDateTime(),this.credentialString(),hash(this.canonicalString(),"hex")].join("\n")};RequestSigner.prototype.canonicalString=function(){(this||d).parsedPath||this.prepareRequest();var e,t=(this||d).parsedPath.path,s=(this||d).parsedPath.query,i=(this||d).request.headers,r="",n=(this||d).service!=="s3",o=(this||d).service==="s3"||(this||d).request.doNotEncodePath,a=(this||d).service==="s3",h=(this||d).service==="s3";e=(this||d).service==="s3"&&(this||d).request.signQuery?"UNSIGNED-PAYLOAD":(this||d).isCodeCommitGit?"":i["X-Amz-Content-Sha256"]||i["x-amz-content-sha256"]||hash((this||d).request.body||"","hex");if(s){var u=Object.keys(s).reduce((function(e,t){if(!t)return e;e[encodeRfc3986Full(t)]=Array.isArray(s[t])&&h?s[t][0]:s[t];return e}),{});var c=[];Object.keys(u).sort().forEach((function(e){Array.isArray(u[e])?u[e].map(encodeRfc3986Full).sort().forEach((function(t){c.push(e+"="+t)})):c.push(e+"="+encodeRfc3986Full(u[e]))}));r=c.join("&")}if(t!=="/"){n&&(t=t.replace(/\/{2,}/g,"/"));t=t.split("/").reduce((function(e,t){if(n&&t==="..")e.pop();else if(!n||t!=="."){o&&(t=decodeURIComponent(t.replace(/\+/g," ")));e.push(encodeRfc3986Full(t))}return e}),[]).join("/");t[0]!=="/"&&(t="/"+t);a&&(t=t.replace(/%2F/g,"/"))}return[(this||d).request.method||"GET",t,r,this.canonicalHeaders()+"\n",this.signedHeaders(),e].join("\n")};RequestSigner.prototype.filterHeaders=function(){var e=(this||d).request.headers,t=(this||d).extraHeadersToInclude,s=(this||d).extraHeadersToIgnore;(this||d).filteredHeaders=Object.keys(e).map((function(t){return[t.toLowerCase(),e[t]]})).filter((function(e){return t[e[0]]||q[e[0]]==null&&!s[e[0]]})).sort((function(e,t){return e[0]<t[0]?-1:1}))};RequestSigner.prototype.canonicalHeaders=function(){(this||d).filteredHeaders||this.filterHeaders();return(this||d).filteredHeaders.map((function(e){return e[0]+":"+e[1].toString().trim().replace(/\s+/g," ")})).join("\n")};RequestSigner.prototype.signedHeaders=function(){(this||d).filteredHeaders||this.filterHeaders();return(this||d).filteredHeaders.map((function(e){return e[0]})).join(";")};RequestSigner.prototype.credentialString=function(){return[this.getDate(),(this||d).region,(this||d).service,"aws4_request"].join("/")};RequestSigner.prototype.defaultCredentials=function(){var e=f.env;return{accessKeyId:e.AWS_ACCESS_KEY_ID||e.AWS_ACCESS_KEY,secretAccessKey:e.AWS_SECRET_ACCESS_KEY||e.AWS_SECRET_KEY,sessionToken:e.AWS_SESSION_TOKEN}};RequestSigner.prototype.parsePath=function(){var e=(this||d).request.path||"/";/[^0-9A-Za-z;,/?:@&=+$\-_.!~*'()#%]/.test(e)&&(e=encodeURI(decodeURI(e)));var t=e.indexOf("?"),s=null;if(t>=0){s=y.parse(e.slice(t+1));e=e.slice(0,t)}(this||d).parsedPath={path:e,query:s}};RequestSigner.prototype.formatPath=function(){var e=(this||d).parsedPath.path,t=(this||d).parsedPath.query;if(!t)return e;t[""]!=null&&delete t[""];return e+"?"+encodeRfc3986(y.stringify(t))};g.RequestSigner=RequestSigner;g.sign=function(e,t){return new RequestSigner(e,t).sign()};export{l as default};

