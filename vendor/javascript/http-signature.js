import r from"assert-plus";import e from"util";import t from"sshpk";import a from"crypto";import i from"http";import s from"jsprim";import o from"buffer";var n="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var h={};var g=r;var d=t;var p=e;var l={sha1:true,sha256:true,sha512:true};var u={rsa:true,dsa:true,ecdsa:true};function HttpSignatureError(r,e){Error.captureStackTrace&&Error.captureStackTrace(this||n,e||HttpSignatureError);(this||n).message=r;(this||n).name=e.name}p.inherits(HttpSignatureError,Error);function InvalidAlgorithmError(r){HttpSignatureError.call(this||n,r,InvalidAlgorithmError)}p.inherits(InvalidAlgorithmError,HttpSignatureError);function validateAlgorithm(r){var e=r.toLowerCase().split("-");if(2!==e.length)throw new InvalidAlgorithmError(e[0].toUpperCase()+" is not a "+"valid algorithm");if("hmac"!==e[0]&&!u[e[0]])throw new InvalidAlgorithmError(e[0].toUpperCase()+" type keys "+"are not supported");if(!l[e[1]])throw new InvalidAlgorithmError(e[1].toUpperCase()+" is not a "+"supported hash algorithm");return e}h={HASH_ALGOS:l,PK_ALGOS:u,HttpSignatureError:HttpSignatureError,InvalidAlgorithmError:InvalidAlgorithmError,validateAlgorithm:validateAlgorithm,sshKeyToPEM:function sshKeyToPEM(r){g.string(r,"ssh_key");var e=d.parseKey(r,"ssh");return e.toString("pem")},fingerprint:function fingerprint(r){g.string(r,"ssh_key");var e=d.parseKey(r,"ssh");return e.fingerprint("md5").toString("hex")},pemToRsaSSHKey:function pemToRsaSSHKey(r,e){g.equal("string",typeof r,"typeof pem");var t=d.parseKey(r,"pem");t.comment=e;return t.toString("ssh")}};var f=h;var m="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var v={};var c=r;var y=e;var w=f;var S=w.HASH_ALGOS;var k=w.PK_ALGOS;var E=w.HttpSignatureError;var H=w.InvalidAlgorithmError;var b=w.validateAlgorithm;var I={New:0,Params:1};var A={Name:0,Quote:1,Value:2,Comma:3};function ExpiredRequestError(r){E.call(this||m,r,ExpiredRequestError)}y.inherits(ExpiredRequestError,E);function InvalidHeaderError(r){E.call(this||m,r,InvalidHeaderError)}y.inherits(InvalidHeaderError,E);function InvalidParamsError(r){E.call(this||m,r,InvalidParamsError)}y.inherits(InvalidParamsError,E);function MissingHeaderError(r){E.call(this||m,r,MissingHeaderError)}y.inherits(MissingHeaderError,E);function StrictParsingError(r){E.call(this||m,r,StrictParsingError)}y.inherits(StrictParsingError,E);v={parseRequest:function parseRequest(r,e){c.object(r,"request");c.object(r.headers,"request.headers");void 0===e&&(e={});void 0===e.headers&&(e.headers=[r.headers["x-date"]?"x-date":"date"]);c.object(e,"options");c.arrayOfString(e.headers,"options.headers");c.optionalFinite(e.clockSkew,"options.clockSkew");var t=e.authorizationHeaderName||"authorization";if(!r.headers[t])throw new MissingHeaderError("no "+t+" header "+"present in the request");e.clockSkew=e.clockSkew||300;var a=0;var i=I.New;var s=A.Name;var o="";var n="";var h={scheme:"",params:{},signingString:""};var g=r.headers[t];for(a=0;a<g.length;a++){var d=g.charAt(a);switch(Number(i)){case I.New:" "!==d?h.scheme+=d:i=I.Params;break;case I.Params:switch(Number(s)){case A.Name:var p=d.charCodeAt(0);if(p>=65&&p<=90||p>=97&&p<=122)o+=d;else{if("="!==d)throw new InvalidHeaderError("bad param format");if(0===o.length)throw new InvalidHeaderError("bad param format");s=A.Quote}break;case A.Quote:if('"'!==d)throw new InvalidHeaderError("bad param format");n="";s=A.Value;break;case A.Value:if('"'===d){h.params[o]=n;s=A.Comma}else n+=d;break;case A.Comma:if(","!==d)throw new InvalidHeaderError("bad param format");o="";s=A.Name;break;default:throw new Error("Invalid substate")}break;default:throw new Error("Invalid substate")}}h.params.headers&&""!==h.params.headers?h.params.headers=h.params.headers.split(" "):r.headers["x-date"]?h.params.headers=["x-date"]:h.params.headers=["date"];if(!h.scheme||"Signature"!==h.scheme)throw new InvalidHeaderError('scheme was not "Signature"');if(!h.params.keyId)throw new InvalidHeaderError("keyId was not specified");if(!h.params.algorithm)throw new InvalidHeaderError("algorithm was not specified");if(!h.params.signature)throw new InvalidHeaderError("signature was not specified");h.params.algorithm=h.params.algorithm.toLowerCase();try{b(h.params.algorithm)}catch(r){throw r instanceof H?new InvalidParamsError(h.params.algorithm+" is not "+"supported"):r}for(a=0;a<h.params.headers.length;a++){var l=h.params.headers[a].toLowerCase();h.params.headers[a]=l;if("request-line"===l){if(e.strict)throw new StrictParsingError("request-line is not a valid header "+"with strict parsing enabled.");h.signingString+=r.method+" "+r.url+" HTTP/"+r.httpVersion}else if("(request-target)"===l)h.signingString+="(request-target): "+r.method.toLowerCase()+" "+r.url;else{var u=r.headers[l];if(void 0===u)throw new MissingHeaderError(l+" was not in the request");h.signingString+=l+": "+u}a+1<h.params.headers.length&&(h.signingString+="\n")}var f;if(r.headers.date||r.headers["x-date"]){f=r.headers["x-date"]?new Date(r.headers["x-date"]):new Date(r.headers.date);var m=new Date;var v=Math.abs(m.getTime()-f.getTime());if(v>1e3*e.clockSkew)throw new ExpiredRequestError("clock skew of "+v/1e3+"s was greater than "+e.clockSkew+"s")}e.headers.forEach((function(r){if(h.params.headers.indexOf(r.toLowerCase())<0)throw new MissingHeaderError(r+" was not a signed header")}));if(e.algorithms&&-1===e.algorithms.indexOf(h.params.algorithm))throw new InvalidParamsError(h.params.algorithm+" is not a supported algorithm");h.algorithm=h.params.algorithm.toUpperCase();h.keyId=h.params.keyId;return h}};var q=v;var _="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var P={};var C=o.Buffer;var T=r;var K=a;var R=i;var M=e;var L=t;var x=s;var j=f;var U=e.format;var O=j.HASH_ALGOS;var N=j.PK_ALGOS;var B=j.InvalidAlgorithmError;var V=j.HttpSignatureError;var D=j.validateAlgorithm;var G='Signature keyId="%s",algorithm="%s",headers="%s",signature="%s"';function MissingHeaderError$1(r){V.call(this||_,r,MissingHeaderError$1)}M.inherits(MissingHeaderError$1,V);function StrictParsingError$1(r){V.call(this||_,r,StrictParsingError$1)}M.inherits(StrictParsingError$1,V);function RequestSigner(r){T.object(r,"options");var e=[];if(void 0!==r.algorithm){T.string(r.algorithm,"options.algorithm");e=D(r.algorithm)}(this||_).rs_alg=e;if(void 0!==r.sign){T.func(r.sign,"options.sign");(this||_).rs_signFunc=r.sign}else if("hmac"===e[0]&&void 0!==r.key){T.string(r.keyId,"options.keyId");(this||_).rs_keyId=r.keyId;if("string"!==typeof r.key&&!C.isBuffer(r.key))throw new TypeError("options.key for HMAC must be a string or Buffer");(this||_).rs_signer=K.createHmac(e[1].toUpperCase(),r.key);(this||_).rs_signer.sign=function(){var r=this.digest("base64");return{hashAlgorithm:e[1],toString:function(){return r}}}}else{if(void 0===r.key)throw new TypeError("options.sign (func) or options.key is required");var t=r.key;("string"===typeof t||C.isBuffer(t))&&(t=L.parsePrivateKey(t));T.ok(L.PrivateKey.isPrivateKey(t,[1,2]),"options.key must be a sshpk.PrivateKey");(this||_).rs_key=t;T.string(r.keyId,"options.keyId");(this||_).rs_keyId=r.keyId;if(!N[t.type])throw new B(t.type.toUpperCase()+" type "+"keys are not supported");if(void 0!==e[0]&&t.type!==e[0])throw new B("options.key must be a "+e[0].toUpperCase()+" key, was given a "+t.type.toUpperCase()+" key instead");(this||_).rs_signer=t.createSign(e[1])}(this||_).rs_headers=[];(this||_).rs_lines=[]}RequestSigner.prototype.writeHeader=function(r,e){T.string(r,"header");r=r.toLowerCase();T.string(e,"value");(this||_).rs_headers.push(r);if((this||_).rs_signFunc)(this||_).rs_lines.push(r+": "+e);else{var t=r+": "+e;(this||_).rs_headers.length>0&&(t="\n"+t);(this||_).rs_signer.update(t)}return e};RequestSigner.prototype.writeDateHeader=function(){return this.writeHeader("date",x.rfc1123(new Date))};RequestSigner.prototype.writeTarget=function(r,e){T.string(r,"method");T.string(e,"path");r=r.toLowerCase();this.writeHeader("(request-target)",r+" "+e)};RequestSigner.prototype.sign=function(r){T.func(r,"callback");if((this||_).rs_headers.length<1)throw new Error("At least one header must be signed");var e,t;if((this||_).rs_signFunc){var a=(this||_).rs_lines.join("\n");var i=this||_;this.rs_signFunc(a,(function(a,s){if(a)r(a);else{try{T.object(s,"signature");T.string(s.keyId,"signature.keyId");T.string(s.algorithm,"signature.algorithm");T.string(s.signature,"signature.signature");e=D(s.algorithm);t=U(G,s.keyId,s.algorithm,i.rs_headers.join(" "),s.signature)}catch(e){r(e);return}r(null,t)}}))}else{try{var s=(this||_).rs_signer.sign()}catch(e){r(e);return}e=((this||_).rs_alg[0]||(this||_).rs_key.type)+"-"+s.hashAlgorithm;var o=s.toString();t=U(G,(this||_).rs_keyId,e,(this||_).rs_headers.join(" "),o);r(null,t)}};P={isSigner:function(r){return"object"===typeof r&&r instanceof RequestSigner},createSigner:function createSigner(r){return new RequestSigner(r)},signRequest:function signRequest(r,e){T.object(r,"request");T.object(e,"options");T.optionalString(e.algorithm,"options.algorithm");T.string(e.keyId,"options.keyId");T.optionalArrayOfString(e.headers,"options.headers");T.optionalString(e.httpVersion,"options.httpVersion");r.getHeader("Date")||r.setHeader("Date",x.rfc1123(new Date));e.headers||(e.headers=["date"]);e.httpVersion||(e.httpVersion="1.1");var t=[];if(e.algorithm){e.algorithm=e.algorithm.toLowerCase();t=D(e.algorithm)}var a;var i="";for(a=0;a<e.headers.length;a++){if("string"!==typeof e.headers[a])throw new TypeError("options.headers must be an array of Strings");var s=e.headers[a].toLowerCase();if("request-line"===s){if(e.strict)throw new StrictParsingError$1("request-line is not a valid header "+"with strict parsing enabled.");i+=r.method+" "+r.path+" HTTP/"+e.httpVersion}else if("(request-target)"===s)i+="(request-target): "+r.method.toLowerCase()+" "+r.path;else{var o=r.getHeader(s);if(void 0===o||""===o)throw new MissingHeaderError$1(s+" was not in the request");i+=s+": "+o}a+1<e.headers.length&&(i+="\n")}r.hasOwnProperty("_stringToSign")&&(r._stringToSign=i);var n;if("hmac"===t[0]){if("string"!==typeof e.key&&!C.isBuffer(e.key))throw new TypeError("options.key must be a string or Buffer");var h=K.createHmac(t[1].toUpperCase(),e.key);h.update(i);n=h.digest("base64")}else{var g=e.key;("string"===typeof g||C.isBuffer(g))&&(g=L.parsePrivateKey(e.key));T.ok(L.PrivateKey.isPrivateKey(g,[1,2]),"options.key must be a sshpk.PrivateKey");if(!N[g.type])throw new B(g.type.toUpperCase()+" type "+"keys are not supported");if(void 0!==t[0]&&g.type!==t[0])throw new B("options.key must be a "+t[0].toUpperCase()+" key, was given a "+g.type.toUpperCase()+" key instead");var d=g.createSign(t[1]);d.update(i);var p=d.sign();if(!O[p.hashAlgorithm])throw new B(p.hashAlgorithm.toUpperCase()+" is not a supported hash algorithm");e.algorithm=g.type+"-"+p.hashAlgorithm;n=p.toString();T.notStrictEqual(n,"","empty signature produced")}var l=e.authorizationHeaderName||"Authorization";r.setHeader(l,U(G,e.keyId,e.algorithm,e.headers.join(" "),n));return true}};var $=P;var F={};var z=o.Buffer;var Q=r;var J=a;var W=t;var X=f;var Y=X.HASH_ALGOS;var Z=X.PK_ALGOS;var rr=X.InvalidAlgorithmError;var er=X.HttpSignatureError;var tr=X.validateAlgorithm;F={verifySignature:function verifySignature(r,e){Q.object(r,"parsedSignature");("string"===typeof e||z.isBuffer(e))&&(e=W.parseKey(e));Q.ok(W.Key.isKey(e,[1,1]),"pubkey must be a sshpk.Key");var t=tr(r.algorithm);if("hmac"===t[0]||t[0]!==e.type)return false;var a=e.createVerify(t[1]);a.update(r.signingString);return a.verify(r.params.signature,"base64")},verifyHMAC:function verifyHMAC(r,e){Q.object(r,"parsedHMAC");Q.string(e,"secret");var t=tr(r.algorithm);if("hmac"!==t[0])return false;var a=t[1].toUpperCase();var i=J.createHmac(a,e);i.update(r.signingString);var s=J.createHmac(a,e);s.update(i.digest());s=s.digest();var o=J.createHmac(a,e);o.update(new z(r.params.signature,"base64"));o=o.digest();return"string"===typeof s?s===o:z.isBuffer(s)&&!s.equals?s.toString("binary")===o.toString("binary"):s.equals(o)}};var ar=F;var ir={};var sr=q;var or=$;var nr=ar;var hr=f;ir={parse:sr.parseRequest,parseRequest:sr.parseRequest,sign:or.signRequest,signRequest:or.signRequest,createSigner:or.createSigner,isSigner:or.isSigner,sshKeyToPEM:hr.sshKeyToPEM,sshKeyFingerprint:hr.fingerprint,pemToRsaSSHKey:hr.pemToRsaSSHKey,verify:nr.verifySignature,verifySignature:nr.verifySignature,verifyHMAC:nr.verifyHMAC};var gr=ir;const dr=ir.parse;export default gr;export{dr as parse};

